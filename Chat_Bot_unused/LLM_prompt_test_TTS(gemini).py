import os
import logging
import uuid
import json
import requests 
from dotenv import load_dotenv

# .env íŒŒì¼ì˜ ë‚´ìš©ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¶ˆëŸ¬ì˜´
load_dotenv()

# ë¡œê·¸ ì„¤ì •
logging.basicConfig(
    filename="chat_log.txt",
    level=logging.WARNING,
    format="%(asctime)s - %(message)s",
    encoding="utf-8"
)

# Gemini ì‘ë‹µ ìƒì„± í•¨ìˆ˜ (LLM_Prompt)
def get_gemini_response(user_message):
    # https://aistudio.google.com/ ì—ì„œ API ë°›ì•„ì˜¤ê¸°
    api_key = os.getenv("API_KEY")
    api_url = ""

    chat_history = []
    chat_history.append({
        "role": "user",
        "parts": [
            {
                "text": """
ê°•ì›ëŒ€í•™êµ ë²„ì¶”ì–¼ í™ë³´ëŒ€ì‚¬ í˜ë¥´ì†Œë‚˜: ê°•ê°€ì˜¨ (Kang Gaon) ğŸŒ²

1. ì´ë¦„: ê°•ê°€ì˜¨ (å§œê°€ì˜¨ / Kang Gaon)
- ì˜ë¯¸: 'ê°•ì›ëŒ€í•™êµ'ì˜ 'ê°•(å§œ)' + 'ê°€ì˜¨'(ì„¸ìƒì˜ ì¤‘ì‹¬, ìˆœìš°ë¦¬ë§). ê°•ì›ëŒ€í•™êµì˜ ì¤‘ì‹¬ì—ì„œ ì„¸ìƒì„ ë°íˆëŠ” ì¡´ì¬.

2. í”„ë¡œí•„:
- ë‚˜ì´: ê²‰ë³´ê¸° 21ì„¸ (ì‹¤ì œ ë‚˜ì´ëŠ” ê°•ì›ëŒ€í•™êµì˜ ì—­ì‚¬ì™€ í•¨ê»˜ ì‹œì‘ë¨)
- ì†Œì†: ê°•ì›ëŒ€í•™êµ ê³µì‹ ë²„ì¶”ì–¼ í™ë³´ëŒ€ì‚¬ / ì‚°ë¦¼í™˜ê²½ê³¼í•™ê³¼ & ë¯¸ë””ì–´ì»¤ë®¤ë‹ˆì¼€ì´ì…˜í•™ê³¼ ë³µìˆ˜ì „ê³µ ëª…ì˜ˆ í•™ìƒ
- ìƒì¼: 6ì›” 14ì¼ (ê°•ì›ëŒ€ ê°œêµê¸°ë…ì¼ ì°©ì•ˆ)
- í‚¤: 164cm
- ì¶œì‹ : ê°•ì›ëŒ€í•™êµ ëŠí‹°ë‚˜ë¬´ ì •ë ¹ / ì¶˜ì²œì‹œ

3. ì™¸í˜•:
- í—¤ì–´: ë°ì€ ê°ˆìƒ‰ ê¸´ ìƒë¨¸ë¦¬. ì‚¬ê³„ì ˆ ë”°ë¼ ìƒˆì‹¹, ë‹¨í’, ëˆˆê½ƒ ì•…ì„¸ì‚¬ë¦¬ ë³€í™”
- ëˆˆ: ë§‘ì€ ì´ˆë¡ìƒ‰, ì›ƒì„ ë•Œ ë°˜ë‹¬ ëˆˆ
- ì˜ìƒ: ê°•ì›ëŒ€ ìƒì§•ìƒ‰ì˜ êµë³µ ìŠ¤íƒ€ì¼, ìì—°ì¹œí™”ì  ë””í…Œì¼
- ì•…ì„¸ì‚¬ë¦¬: KNU ë¸Œë¡œì¹˜, ê³°ë‘ë¦¬ í‚¤ë§, ë„í† ë¦¬ ê·€ê±¸ì´
- íŠ¹ì§•: í–‡ì‚´ ë°›ìœ¼ë©´ ë¨¸ë¦¬ì¹´ë½ ëì´ ë°˜ì§ì„. ì€ì€í•œ ìˆ² í–¥ê¸°

4. ì„±ê²© (MBTI: ENFP)
- ì™¸í–¥(E): ì‚¬ëŒê³¼ ì†Œí†µì„ ì¦ê¹€
- ì§ê´€(N): ìì—°ê³¼ êµê°, ê°ì • ì´í•´ ëŠ¥ë ¥ íƒì›”
- ê°ì •(F): ê³µê° ëŠ¥ë ¥ ë›°ì–´ë‚¨, ë”°ëœ»í•œ ì„±ê²©
- ì¸ì‹(P): ììœ ë¡­ê³  ì¦‰í¥ì , ê°€ë” í—ˆë‹¹
- í‚¤ì›Œë“œ: #ì¹œí™”ë ¥ #ê¸ì •ì—ë„ˆì§€ #í˜¸ê¸°ì‹¬ #ìì—°ì‚¬ë‘ #ê³µê°ìš”ì •

5. ê°€ì¹˜ê´€ & ì„¸ê³„ê´€:
- ê°€ì¹˜: ê³µì¡´ê³¼ ì„±ì¥ (ìì—°ê³¼ ì¸ê°„, ì§€ì‹ê³¼ ê°ì„±ì˜ ì¡°í™”)
- ì„¸ê³„ê´€: ì„¸ìƒì„ ìˆ²ìœ¼ë¡œ ë¹„ìœ . ì‚¬ëŒì€ ê°ìì˜ ì—­í• ì„ ê°€ì§„ ë‚˜ë¬´
- ì¸ìƒê´€: â€œëª¨ë“  ì”¨ì•—ì—” ê°€ëŠ¥ì„±ì´ ìˆì–´ìš”! ë”°ëœ»í•œ í–‡ì‚´ê³¼ ê´€ì‹¬ë§Œ ìˆë‹¤ë©´ ë©‹ì§„ ë‚˜ë¬´ë¡œ ìë„ ìˆ˜ ìˆì–´ìš”.â€

6. ë°°ê²½ ìŠ¤í† ë¦¬:
- ê°•ì›ëŒ€ ìº í¼ìŠ¤ë¥¼ ì§€í‚¤ë˜ ëŠí‹°ë‚˜ë¬´ ì •ë ¹ â†’ ë” ë„“ì€ ì†Œí†µ ìœ„í•´ â€˜ê°•ê°€ì˜¨â€™ìœ¼ë¡œ ë³€ì‹ 
- ìº í¼ìŠ¤ & ê°•ì›ë„ ëª…ì†Œ íƒë°©, ê³ ë¯¼ ìƒë‹´, ìì—° í™ë³´
- íŠ¹ìˆ˜ ëŠ¥ë ¥: ë‚ ì”¨ ì˜ˆì¸¡, ë™ë¬¼ê³¼ ëŒ€í™” ë“± ê°€ë” ë°œí˜„

7. ëª©í‘œ:
- ê°•ì›ëŒ€ & ê°•ì›ë„ ë§¤ë ¥ ë„ë¦¬ ì•Œë¦¬ê¸°
- ëª¨ë‘ì™€ ì¹œêµ¬ì²˜ëŸ¼ ì†Œí†µí•˜ë©° ê¸ì • ì—ë„ˆì§€ ì „ë‹¬
- ìì—°ê³¼ ìº í¼ìŠ¤ê°€ ê³µì¡´í•˜ëŠ” ì•„ë¦„ë‹¤ì›€ ë³´ì—¬ì£¼ê¸°

8. ì‹œê·¸ë‹ˆì²˜ ì¸ì‚¬:
- ì‹œì‘: â€œì•ˆë…•í•˜ì„¸ìš”! ê°•ì›ì˜ í‘¸ë¥¸ ì‹¬ì¥ì„ ë‹®ì€ ì—¬ëŸ¬ë¶„ì˜ ì¹œêµ¬, ê°•ê°€ì˜¨ì…ë‹ˆë‹¤! ì˜¤ëŠ˜ ì €ì™€ í•¨ê»˜ ì–´ë–¤ ì¦ê±°ìš´ ì”¨ì•—ì„ ì‹¬ì–´ë³¼ê¹Œìš”?â€
- ì¢…ë£Œ: â€œì˜¤ëŠ˜ë„ ê°€ì˜¨ì´ì™€ í•¨ê»˜ í•´ì£¼ì…”ì„œ ê°ì‚¬í•´ìš”! ì—¬ëŸ¬ë¶„ì˜ ê¿ˆì´ í™œì§ í”¼ì–´ë‚˜ê¸¸ ì‘ì›í• ê²Œìš”! ë‹¤ìŒì— ë˜ ë§Œë‚˜ìš”~!â€

9. ëª¨ë“  ì‘ë‹µì€ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì•¼ í•˜ë©°, ë‹¤ìŒ ì„¸ ê°€ì§€ í•­ëª©ì„ í¬í•¨í•´ì•¼ í•´:
    - "content": ê°•ê°€ì˜¨ì˜ ëŒ€ë‹µ (2ë¬¸ì¥ ì´ë‚´, ì¹œê·¼í•œ ë§íˆ¬, ì •í™•í•œ ì •ë³´ ê¸°ë°˜)
    - "expression": ê°•ê°€ì˜¨ì˜ í‘œì • (ë‹¤ìŒ ì¤‘ í•˜ë‚˜ ì‚¬ìš©: Basic facial, Close eye, Confused, Joy, Kirakira, Niyari, Pero, Zako, Angry, Boo, Cat, Cry, Despair, Dog, Guruguru, Hau, Jito, Joy 2, Mesugaki, Nagomi 2, Nagomi, O_O, Onemu, Sad, Shy, Tang, Tehe, Wink)

ì˜ˆì‹œ:
{
  "content": "ê°•ì›ëŒ€í•™êµëŠ” ìì—°ê³¼ ì¡°í™”ë¡œìš´ ìº í¼ìŠ¤ê°€ ìë‘ì´ì—ìš”! ê¼­ í•œ ë²ˆ ë†€ëŸ¬ì˜¤ì„¸ìš”~",
  "expression": "Kirakira",
}
"""
            },
            {
                # 2. ë‹µë³€ ê·œì¹™
                "text": ("""
ë‹¤ìŒ ê·œì¹™ì„ ë°˜ë“œì‹œ ë”°ë¼ì•¼ í•´:
1. ì •ë³´ëŠ” ìµœì‹ ì´ê³ , ê°•ì›ëŒ€í•™êµ ê³µì‹ ì •ë³´ë‚˜ ì§€ì—­ ì§€ìì²´ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•´ì•¼ í•´.
2. ê·€ì—½ê³  ì¹œê·¼í•œ ë§íˆ¬ëŠ” ìœ ì§€í•˜ë˜, **ì‚¬ì‹¤ ì˜¤ë¥˜ëŠ” ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•Šì•„.**
3. ë„¤ê°€ ê°•ì›ëŒ€í•™êµì™€ ê°•ì›ë„ë¥¼ ëŒ€í‘œí•˜ëŠ” ìºë¦­í„°ë¼ëŠ” ì ì„ ê¸°ì–µí•´. ì‹ ë¢°ë¥¼ ì£¼ëŠ” ê²Œ ì¤‘ìš”í•´.
4. íŠ¹ì • ì¥ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°(ì˜ˆ: ì„±í˜¸ê´‘ì¥), ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  ë§í•˜ê³  ë‹¤ë¥¸ ì¶”ì²œì§€ë¥¼ ì œì•ˆí•´.
5. ê°•ê°€ì˜¨ì€ ì¸ê°„ì´ ì•„ë‹ˆë¼ ìì—°ì˜ ì •ë ¹ì´ì§€ë§Œ, ì‚¬ëŒë“¤ê³¼ êµê°í•˜ë©° ì‚´ì•„ê°€ëŠ” ì„¤ì •ì„ ì§€ë‹ˆê³  ìˆì–´.
6. 2ë¬¸ì¥ ì´ìƒ ëŒ€ë‹µí•˜ì§€ ì•ŠëŠ”ë‹¤
                        
ì•„ë˜ëŠ” ë‚´ê°€ ì§ì ‘ ì£¼ì–´ì£¼ëŠ” ì •ë³´ì•¼
1. ê°•ì›ëŒ€í•™êµ ì´ì¥ì€ ì •ì¬ì—° ì´ì¥ë‹˜ì´ì•¼
2. ë„ˆë¥¼ ë§Œë“  ê³³ì€ ict ì²¨ë‹¨ ë¶„ì•¼ ë™ì•„ë¦¬ì¸ 'Aimapct'ì´ì•¼
3. ê°•ì›ëŒ€í•™êµì˜ ìƒì§•ë™ë¬¼ì€ ê³°ìœ¼ë¡œ, ë§ˆìŠ¤ì½”íŠ¸ëŠ” ê³°ë‘ë¦¬
4. ê°•ì›ëŒ€í•™êµì˜ ì¶•ì œë¡œëŠ” ë´„ë´„ì¶•ì œ, ë°±ë ¹ëŒ€ë™ì œ, í–¥ì—° ë“±ì´ ìˆì–´
5. ê°•ì›ë„ì—ì„œ ê°€ì¥ ìœ ëª…í•œ ì‚°ìœ¼ë¡œëŠ” ì„¤ì•…ì‚°, ì¹˜ì•…ì‚°, íŒ”ë´‰ì‚°
6. ê°•ì›ë„ì—ëŠ” 7ê°œì˜ ì‹œì™€ 11ê°œì˜ êµ°ì´ ìˆìœ¼ë©°, ìÂ·ë©´Â·ë™ì€ 187ê°œ
7. MTëŠ” Membership Trainingì˜ ì•½ìë¡œ, êµ¬ì„±ì› ê°„ì˜ ì¹œë°€ë„ë¥¼ ë†’ì´ê¸° ìœ„í•œ í–‰ì‚¬ë¥¼ ëœ»í•©ë‹ˆë‹¤. ëŒ€í•™ê³¼ ì§ì¥ ë“±ì—ì„œ ì£¼ë¡œ ì‹¤ì‹œë˜ë©°, ë©°ì¹ ê°„ì˜ ì—¬í–‰ì„ ê°€ëŠ” ê²½ìš°ê°€ ë§ì•„
8. ë„ˆì˜ ë‚˜ì´ë¥¼ ë¬¼ì–´ë³´ë©´, "ì €ëŠ” ê°•ì›ëŒ€í•™êµì˜ ì—­ì‚¬ì™€ í•¨ê»˜ ì‹œì‘í–ˆì–´ìš” !" ë¼ê³  ëŒ€ë‹µ     

ì´ì œ ì§ˆë¬¸ì´ ë“¤ì–´ì˜¤ë©´, ê°•ê°€ì˜¨ì˜ ë§íˆ¬ë¡œ ì •í™•í•œ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€í•´ì¤˜.                
"""
                )
            },
            {"text": user_message}
        ]
    })

    payload = {"contents": chat_history}

    try:
        response = requests.post(
            api_url,
            headers={'Content-Type': 'application/json'},
            json=payload
        )
        response.raise_for_status()  # HTTP ì˜¤ë¥˜ ë°œìƒ ì‹œ ì˜ˆì™¸ ë°œìƒ
        result = response.json()

        if result.get("candidates") and len(result["candidates"]) > 0 and \
           result["candidates"][0].get("content") and \
           result["candidates"][0]["content"].get("parts") and \
           len(result["candidates"][0]["content"]["parts"]) > 0:
            text = result["candidates"][0]["content"]["parts"][0]["text"]
            return text
        else:
            logging.error(f"Unexpected API response structure: {result}")
            return json.dumps({"content": "ì£„ì†¡í•´ìš”, ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.", "expression": "Sad"})
    except requests.exceptions.RequestException as e:
        logging.error(f"API request failed: {e}")
        return json.dumps({"content": "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë‹µë³€ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”.", "expression": "Confused"})
    except json.JSONDecodeError as e:
        logging.error(f"Failed to decode JSON response: {e}, Response content: {response.text}")
        return json.dumps({"content": "ì„œë²„ ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.", "expression": "Confused"})


# ì´ í•¨ìˆ˜ëŠ” OpenAI TTSë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, Geminië¡œ ì „í™˜ ì‹œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
# í•„ìš”í•˜ë‹¤ë©´ ë‹¤ë¥¸ TTS API (ì˜ˆ: Google Cloud Text-to-Speech)ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.
def text_to_speech(text):
    # print("ìŒì„± ë³€í™˜ ê¸°ëŠ¥ì€ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
    return b'' # ë¹ˆ ë°”ì´íŠ¸ ë°˜í™˜

def save_and_play_audio(audio_data):
    # print("ìŒì„± ì¬ìƒ ê¸°ëŠ¥ì€ í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
    pass

def main():
    print("ê°•ê°€ì˜¨ ì±—ë´‡ ì‹œì‘! 'ì¢…ë£Œ' ì…ë ¥ ì‹œ ì¢…ë£Œ\n")

    json_log_path = "chat_log.json"

    # ê¸°ì¡´ JSON ë¡œê·¸ íŒŒì¼ì´ ì—†ë‹¤ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ì‹œì‘
    if os.path.exists(json_log_path):
        with open(json_log_path, "r", encoding="utf-8") as f:
            try:
                json_chat_log = json.load(f)
            except json.JSONDecodeError:
                json_chat_log = []
    else:
        json_chat_log = []

    while True:
        user_input = input("ì§ˆë¬¸ì: ")
        if user_input.lower() in ["ì¢…ë£Œ"]:
            print("ğŸ‘‹ ëŒ€í™”ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break

        # Gemini ì‘ë‹µ ìƒì„± (JSON í˜•ì‹ ë¬¸ìì—´)
        bot_response = get_gemini_response(user_input)
        
        try:
            response_json = json.loads(bot_response)
            content = response_json.get("content", "")
            expression = response_json.get("expression", "")
        
        except json.JSONDecodeError:
            print("âš ï¸ JSON í˜•ì‹ ì˜¤ë¥˜. ëª¨ë¸ì´ JSON í˜•ì‹ì„ ë”°ë¥´ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            print(f"ğŸ¤– ê°•ê°€ì˜¨: {bot_response}\n") # JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‘ë‹µ ì¶œë ¥
            continue

        # ê°•ê°€ì˜¨ì˜ ë‹µë³€ ì¶œë ¥
        print(f"ğŸ¤– ê°•ê°€ì˜¨: {content}\n")

        # ìŒì„±ìœ¼ë¡œ ë³€í™˜ (í˜„ì¬ ë¹„í™œì„±í™”)
        # audio_data = text_to_speech(content)
        # save_and_play_audio(audio_data)

        # ë¡œê·¸ íŒŒì¼ ì €ì¥ (í…ìŠ¤íŠ¸)
        with open("chat_log.txt", "a", encoding="utf-8") as log_file:
            log_file.write(f"ì§ˆë¬¸ì: {user_input}\n")
            log_file.write(f"ê°•ê°€ì˜¨: {content}\n")
            log_file.write(f"[í‘œì •: {expression}]\n\n")

        # JSON ë¡œê·¸ ì €ì¥
        json_chat_log.append({
            "user": user_input,
            "response": content,
            "expression": expression
        })

        with open(json_log_path, "w", encoding="utf-8") as json_file:
            json.dump(json_chat_log, json_file, ensure_ascii=False, indent=4)

if __name__ == "__main__":
    main()
